#o8n — Specification

This document specifies the o8n terminal UI application (written in Go). It fully describes the architecture, data models, UI layout and behavior, configuration files, API interactions, error handling, and tests. The intent is that a developer or an AI coder can reimplement the same structure and behavior from this specification.

## High-level summary

- Language: Go (>= 1.24).
- Primary runtime library: Charmbracelet ecosystem (bubbletea, bubbles, lipgloss).
- Function: Provide a terminal UI to browse and operate on resources exposed by an Operaton/engine-rest API (process definitions, instances, variables, tasks, jobs, etc.).
- The application should have a similar look & feel like k9s (layout, keyboard usage)
- Use the Operaton REST API

## Repository layout (conceptual)

- main.go — main application, model, update/view, UI wiring.
- api.go — HTTP client wrapper code that uses the generated OpenAPI client to interact with Operaton engine-rest endpoints.
- internal/operaton/ — Generated OpenAPI client code from resources/operaton-rest-api.json (generated by .devenv/scripts/generate-api-client.sh).
- internal/contentassist/ — Thread-safe user suggestion cache (SuggestUsers).
- config.go — config loading/saving for environment and app config.
- o8n-env.yaml.example — example environment file with ui_color and credentials (sensitive, do not commit real secrets).
- o8n-env.yaml (runtime) — environment configuration (kept out of source control).
- o8n-cfg.yaml — application-level configuration (table definitions, column specs, action definitions).
- resources/operaton-rest-api.json — OpenAPI / swagger reference used to derive root contexts and generate the Go client.
- .devenv/scripts/generate-api-client.sh — Script to generate the Go client from the OpenAPI specification using OpenAPI Generator.
- tests (go test unit tests) — exercises config load and API client behaviours.

# UX

## Overview

The o8n terminal UI follows professional UX patterns inspired by k9s, with optimized layouts, intuitive keyboard navigation, and polished interactions.

**Detailed Design Documents:**
- [Splash Screen Design](_bmad/core/prds/splash-screen-design.md) — 1.2s branded splash with logo animation
- [Compact Header Design](_bmad/core/prds/compact-header-design.md) — Priority-based compact header with adaptive key hints
- [Layout Design](_bmad/core/prds/layout-design-optimized.md) — Responsive layout system for 80-160+ char terminals
- [Modal Confirmation Design](_bmad/core/prds/modal-confirmation-design.md) — Simple confirmation pattern for destructive actions
- [Help Screen Design](_bmad/core/prds/help-screen-design.md) — Comprehensive keyboard shortcuts reference

## Key Interaction Patterns

### Keymap Convention
- **Destructive actions**: `<ctrl>+` prefix (e.g., `<ctrl>+d` delete/terminate, `<ctrl>+c` quit)
- **Navigation actions**: arrow keys, `Enter`, `Esc`, `Page Up/Down`
- **Edit action**: `e` opens edit modal for the selected row (when editable columns exist)
- **Global actions**: `:` context switch, `<ctrl>+e` environment switch, `?` help

### Layout Structure
- **Splash Screen** (startup): 1.2s logo animation with version display
- **Header** (3–8 rows adaptive): Environment info, key hints (priority-based visibility), logo. Current implementation: compact 3-row header + 1 top spacer = 4 rows.
- **Context Selection** (1 row boxed, dynamic): Opens with `:`, inline completion, Tab to complete, Enter to switch
- **Main Content** (fills remaining space): Boxed table with responsive columns
- **Footer** (1 row): Breadcrumb context tag | Status message | Remote activity indicator (⚡)

### Navigation & Drill-Down
- **Arrow keys**: Navigate rows in current view
- **Enter**: Drill down (definitions → instances → variables)
- **Esc**: Go back one level (pops navigation stack)
- **Page Up/Down** (`pgup`/`pgdn` or `ctrl+b`/`ctrl+f`): Jump through table pages (server-side pagination)
- **1–4**: Navigate directly to breadcrumb level N (1 = root)

### Tables
- **Selected rows**: Inverted colors (font ↔ background)
- **Responsive columns**: Shrink to title width + 1 space, hide low-priority columns at narrow widths
- **Content abbreviation**: Truncate with "..." when space limited
- **Column configuration**: Visible, width (%), align, hide-able flag, editable flag
- **Editable column markers**: Editable cells are shown with `[E]` suffix in the table

### Modal Confirmations — Destructive Actions
- **Trigger**: Destructive actions (delete, terminate) show a `ModalConfirmDelete` dialog
- **Pattern**: Press `<ctrl>+d` once to open the modal; press `<ctrl>+d` again to confirm and execute
- **Cancellation**: Any other key or Esc cancels the modal and shows "Cancelled" briefly in the footer
- **Visual**: Centered modal dialog with color-coded prompt

### Edit Modal
- **Trigger**: Press `e` when the current view has editable columns (e.g., the variables view)
- **Modal type**: `ModalEdit`
- **Column cycling**: `Tab` / `Shift+Tab` move between editable columns
- **Bool toggle**: `Space` toggles boolean fields between `true` and `false`
- **Save**: `Enter` validates the input and persists the change via the API; closes modal on success
- **Cancel**: `Esc` closes modal without saving
- **Validation**: Type-aware validation (bool, int, float, json, text) via `internal/validation`; errors displayed inline in the modal
- **Editable tables**: Currently only the variables view supports editing (via the Operaton variable API)

### Help Modal
- **Trigger**: `?`
- **Content**: Keyboard shortcuts reference
- **Dismiss**: Any key

### Responsive Design
- **Terminal resize**: All sections adapt dynamically
- **Width breakpoints**: 80, 100, 120, 140+ characters
- **Priority system**: Key hints show/hide based on priority (1=always visible, 9=only at 140+ width)
- **Fixed sections**: Header, footer, context switch (when open)
- **Flexible section**: Main content table grows/shrinks

### Styling & Theming
- **Skins**: Color schemes in `/skins` folder (dracula, nord, gruvbox, etc.)
- **Active skin**: Defined in `o8n-env.yaml`, switchable at runtime
- **Footer breadcrumb**: Environment-specific background color, up to 3 sections
- **Remote indicator**: Flash (⚡) for 0.2s on REST API calls

### Context Switching
- **Trigger**: `:` key opens context selection
- **Input**: 1-line boxed section (3 rows with border)
- **Completion**: Inline gray suffix after first character typed
- **Actions**: Tab completes, Enter switches (exact match only), Esc cancels
- **Focus**: Keyboard focus moves to context input line

### Default Behavior
- **Environment**: "local" (if configured) or first available environment
- **Root context**: process-definitions
- **Auto-refresh**: Toggle with `r` or `<ctrl>+r` (5s interval when enabled)

# Architecture and major components

## Program model (main.go)
   - Uses the Bubble Tea model pattern with Init, Update, and View.
   - Model fields include:
     - config *Config — compatibility view combining environment and table definitions.
     - envConfig *EnvConfig and appConfig *AppConfig — split configs;
     - UI components: bubbles list.Model (for a list-based view) and bubbles table.Model for the main table.
     - UI state: currentEnv, envNames, currentRoot (root context like `process-definition`), viewMode ("definitions","instances","variables"), selectedInstanceID, autoRefresh, flashActive, footerError, showRootPopup, rootInput.
     - Layout sizing: lastWidth/lastHeight, paneWidth/paneHeight.
     - Navigation: navigationStack []viewState, breadcrumb []string, contentHeader string.
     - Modal state: activeModal ModalType, modalConfirmKey string, pendingDeleteID string.
     - Edit modal state: editInput textinput.Model, editColumns []editableColumn, editColumnPos int, editRowIndex int, editTableKey string, editError string.
     - Pagination state: pageOffsets map[string]int, pageTotals map[string]int, pendingCursorAfterPage int.
   - Main event loop reacts to key presses and window size messages. It orchestrates API fetch commands and updates the table/list state.

## Navigation Stack & Breadcrumb

- **viewState** struct captures a complete snapshot of a view: viewMode, breadcrumb, contentHeader, selectedDefinitionKey, selectedInstanceID, tableRows, tableCursor, cachedDefinitions, tableColumns.
- **navigationStack []viewState** — LIFO stack; a new state is pushed when drilling down (Enter on definition → instances, Enter on instance → variables). Esc pops the stack and restores the previous view.
- **breadcrumb []string** — ordered list of context labels shown in the footer (e.g., ["process-definitions", "my-process", "variables"]). Clicking breadcrumb level N (keys `1`–`4`) navigates directly to that level.
- **contentHeader string** — label shown above the table (the current resource name).

## Modal Types

```go
type ModalType int

const (
    ModalNone ModalType = iota
    ModalConfirmDelete
    ModalConfirmQuit
    ModalHelp
    ModalEdit
)
```

## Data model (Go structs used by the API client)
- Environment { URL, Username, Password, UIColor }
- ColumnDef { Name, Visible bool, Width string, Align string, Editable bool }
- TableDef { Name string, DisplayName string, Columns []ColumnDef, Actions []ActionDef }
- ActionDef { Name string, Command string, Confirmation bool }
  - Name: display name for the action shown in key bindings header
  - Command: key binding string to trigger the action (e.g., "ctrl+d")
  - Confirmation: when true, execution requires a confirmation modal before executing
- EnvConfig { Environments map[string]Environment, Active string }
- AppConfig { Tables []TableDef }
- Data models for application elements (e.g. Process Definition, are defined by the REST API specification
- TableDef#DisplayName defaults to TableDef#Name capitalized, `-` replaced by ` ` (e.g. `job` -> `Job`, `process-definition` -> `Process Definition`)

## API client (api.go)
   - Client struct holds the environment info, *http.Client, generated *operaton.APIClient, and authentication context.
   - The generated client is created from resources/operaton-rest-api.json using OpenAPI Generator.
   - Primary methods:
     - FetchProcessDefinitions() -> []ProcessDefinition (uses generated ProcessDefinitionAPI.GetProcessDefinitions)
     - FetchInstances(processDefinitionKey) -> []ProcessInstance (uses generated ProcessInstanceAPI.GetProcessInstances)
     - FetchVariables(instanceId) -> []Variable (uses generated ProcessInstanceAPI.GetProcessInstanceVariables)
     - TerminateInstance(instanceId) -> error (uses generated ProcessInstanceAPI.DeleteProcessInstance)
   - FetchVariables robustly handles the variable map format returned by the REST API: a map keyed by variable name with VariableValueDto containing value/type; returns []Variable with Name, Value (stringified), Type.
   - Errors are returned and propagated back as errMsg messages.
   - The generated client code is located in internal/operaton/ and includes comprehensive API coverage for all Operaton REST endpoints.

## Configuration (config.go + YAML files)

### EnvConfig (o8n-env.yaml)

- environments: map[string]{ url, username, password, ui_color }
- active: string (name of active environment)

### AppConfig (o8n-cfg.yaml)
- tables: array of TableDef (name, columns, actions)
  - Each table definition corresponds to a resource collection endpoint, e.g.
    `process-definition` -> `GET /process-definition`
  - actions: array of ActionDef
    - name: Action name displayed in the Key bindings in the header section
    - command: Key binding to trigger the command
    - confirmation: When true, then execution requires confirmation

- ColumnDef: { name, visible, width (percent string like "25%"), align, editable }
- For compatibility the application exposes LoadConfig(path) to load legacy single-file config.yaml used by tests; also provides LoadEnvConfig and LoadAppConfig and Save helpers. SaveConfig writes back to o8n-env.yaml and o8n-cfg.yaml (best-effort).

## Pagination

- All collection endpoints are fetched with server-side pagination using `firstResult` (offset) and `maxResults` (page size) query parameters.
- **pageOffsets map[string]int** — tracks the current page offset per root context key.
- **pageTotals map[string]int** — tracks the known total count per root context (fetched from a `/count` endpoint alongside the main fetch).
- **Page size** is computed from the visible table height (`getPageSize()`).
- **Page Down** (`pgdn`/`ctrl+f`): advance offset by page size; clamp to last page if total is known; refetch.
- **Page Up** (`pgup`/`ctrl+b`): decrease offset by page size; clamp to zero; refetch.
- **pendingCursorAfterPage int** — the table cursor position to restore after a page fetch completes.
- When fetching, the flash indicator (⚡) is shown.

## Content Assist

- Package `internal/contentassist` provides a thread-safe user suggestion cache.
- **SetUserCache(items []string)** — replaces the internal cache (used in tests or initialization).
- **SuggestUsers(prefix string) []string** — returns up to 5 suggestions case-insensitively matching the given prefix; returns top 5 if prefix is empty.
- The cache is protected by a `sync.RWMutex`.

## UI Rendering (main.go View)
   - Vertical layout in exact order:
     1. Header (3–8 rows adaptive; current implementation: compact 3-row header + 1 top spacer = 4 rows total)
        - Row 1: Status line — app version, environment name, URL, username
        - Row 2: Key hints — priority-based list of key+description pairs, space-separated
        - Row 3: Empty spacer
        - Header uses full terminal width with 1-character horizontal padding; bold font; no forced background color.
     2. Context selection box (1 row boxed) — visible when `:` is pressed; otherwise an empty boxed placeholder. It contains a single-line text input.
        - Behavior: input is empty initially; no completions shown until first character typed; inline completion (gray color) shows the remaining suffix of the first matching root context; Tab completes; Enter tries to switch context only if exact match; Esc cancels and clears input.
     3. Main content (boxed table) — uses table.Model to render rows and headers. The table consumes the remaining height between header/context selection/footer. Table header text is uppercase and uses a header color (white). Column widths are computed using the configured percent widths from AppConfig when present; otherwise columns get equal widths.
     4. Footer (1 row) — three columns separated by " | ":
        - Column 1: Context tag (e.g. "<process-definition>") — left aligned, largest column (space for long names like historic-external-task-log); uses environment UI color as background and black text.
        - Column 2: Message — used to display errors (footerError) or other status. Truncated as needed.
        - Column 3: Remote access indicator — single character; displays "⚡" for 0.2s after issuing a REST call; otherwise blank.

## UI Styles and Colors
   - Primary border and accent color: environment.UIColor (from env config).
   - Table header foreground color is white.
   - Completion suffix is gray (#666666) by default.
   - Footer error message style: red (#FF0000) and bold.
   - The context selection input uses the environment border color as its font color by default (config allows extension to custom color names).

## Keybindings and behavior
   - `<ctrl>+c`: quit
   - `<ctrl>+e`: switch environment (cycles through configured envNames). Persists active environment to o8n-env.yaml (best-effort).
   - `r` or `<ctrl>+r`: toggle auto-refresh. When enabled, periodically refresh definitions with interval (5s). When disabled, manual selection changes may set a manualRefreshTriggered flag used for UI hints.
   - `:` (colon): toggle context-selection input box. Focus is inside the input when open.
     - Typing: appends a single rune per key event to rootInput.
     - Completion: only when rootInput length >= 1; inline suffix shown for the first match.
     - Tab: completes rootInput to the first matching root context.
     - Enter: switch context only when rootInput exactly equals a known root context. When switched:
       - close the input box
       - clear footer errors
       - set currentRoot
       - fetch top-level data for the new context (e.g., process-definitions table rows)
       - set focus of table to the first row (implementation note below)
     - Esc: cancel input and close box.
     - Backspace: remove last character from rootInput.
   - `?`: open help modal (ModalHelp). Any key dismisses it.
   - `e`: open edit modal (ModalEdit) for the selected row, if the current table has editable columns. Shows "No editable columns" error in footer otherwise.
   - Arrow keys: move selection in list/table. Important: in the process-definition view the arrow keys navigate definitions only; Enter is required to drill down into instances.
   - Page up/down (`pgup`/`pgdn`, `ctrl+b`/`ctrl+f`): paginate through server-side results
   - `1`–`4`: navigate directly to breadcrumb level N (1-based) when context popup is not open
   - Enter: drills down from definitions -> instances -> variables. In variables view Enter does nothing.
   - `<ctrl>+d`: trigger delete/terminate for the selected instance.
     - First press: opens ModalConfirmDelete and stores pendingDeleteID.
     - Second press (`<ctrl>+d` again): confirms and calls TerminateInstance; closes modal.
     - Any other key while modal is open: cancels, shows "Cancelled" for 2 seconds.
   - `Esc`:
     - When context popup is open: close popup and clear rootInput.
     - When navigation stack is non-empty: pop stack and restore previous view.
     - When edit modal is open: handled by ModalEdit key handler — closes modal without saving.

## Fetching & Flow

- On Init: program sends fetchDefinitionsCmd and triggers the flash (flashOnCmd). fetchDefinitionsCmd uses the current environment to call Client.FetchProcessDefinitions.
- When Enter on a definition selected: fetchInstancesCmd(key) is issued which calls Client.FetchInstances(key) and then applyInstances.
- When Enter on an instance: fetchVariablesCmd(id) issued which calls Client.FetchVariables and then applyVariables.
- Generic fetch: fetchForRoot(root) fetches any root context using HTTP directly with firstResult/maxResults pagination and optional query parameters.

## Error handling
   - All API errors are returned as errMsg messages and the main Update() stores the error text in m.footerError and schedules a clear after **5 seconds** (clearErrorMsg).
   - Rendering functions (applyDefinitions, applyInstances, applyVariables) use defer/recover to catch panics and set m.footerError with an explanatory message rather than letting the program crash.
   - The UI will show error messages prominently in the footer message column with the error style.

## Table definition config: o8n-cfg.yaml
- Top-level: tables: array of { name: string, columns: [ { name, visible, width, align, editable } ], actions: [ { name, command, confirmation } ] }
- Example table def for process-definitions:
  - name: process-definitions
    columns:
      - name: key
        visible: true
        width: 20%
        align: left
      - name: name
        visible: true
        width: 40%
        align: left
      - name: version
        visible: true
        width: 15%
        align: center
      - name: resource
        visible: true
        width: 25%
        align: left
- Column width interpretation: the UI parses the percent string (e.g., "25%") and computes absolute character widths based on available content width; remaining percentage split equally among unspecified columns.
- Column types:
- Built-in types:
  - id:
      type: string
  - date-time
- Implicit types:
  - columns named `id` or ending with `Id` are implicit of type `id`
- Editable columns: columns with `editable: true` can be edited via the edit modal. Currently only supported in the variables view.


## Messages and Commands (Bubble Tea)
    - Messages (Go types): refreshMsg, definitionsLoadedMsg, instancesLoadedMsg, variablesLoadedMsg, dataLoadedMsg, genericLoadedMsg, instancesWithCountMsg, errMsg, flashOnMsg, flashOffMsg, clearErrorMsg, terminatedMsg, splashDoneMsg, splashFrameMsg
    - Commands: fetchDefinitionsCmd, fetchInstancesCmd, fetchVariablesCmd, fetchDataCmd, fetchForRoot, terminateInstanceCmd, flashOnCmd, setVariableCmd
    - flashOnCmd returns flashOnMsg that Update() uses to set m.flashActive and schedule flashOffMsg after 200ms.

## Tests
    - Unit tests cover: API client behaviors (mock HTTP server), config loading (legacy and split), and model functions (applyData populates table rows, selection change behaviour triggers manualRefresh flag, flash on/off, pagination offset logic, cursor-based pagination, edit modal rendering and validation, generic data fetch). Tests are run with `go test ./...`.
    - Packages without test files: internal/config, internal/contentassist, internal/dao — these should have tests added.

## Build and run
  - Build:
  ```bash
  go build -o o8n .
  ```

  - Run:
  ```bash
  ./o8n
  ```

  - Tests:
  ```bash
  go test ./... -v
  ```
    - Regenerate API client:
```bash
./.devenv/scripts/generate-api-client.sh
```

## Implementation notes and edge cases
    - The variables endpoint may return different JSON structures; FetchVariables must try decoding to map[string]{value,type} first and fall back to array decoding (re-request or reuse body accordingly).
    - When computing column widths from percentages, normalize percentages if they do not sum to 100. If some columns do not specify a width, distribute remaining percentage evenly.
    - Table rows must be normalized to the configured column count to avoid panics in the table renderer; implement a normalizeRows(rows, colsCount) helper to pad/truncate rows.
    - Always guard UI render code that depends on external data with recover() so the TUI doesn't crash because of a malformed API response.
    - When context selection is invoked, do not present inline completion until the user has typed at least one character. Tab completes to the first match; Enter requires exact match.
    - When switching root contexts programmatically, update the footer context tag and trigger fetch of the root context's primary resource. Also ensure the table selection/focus moves to the first row (implementation detail: use table.SetCursor or equivalent if available; otherwise ensure rows are selected and visible on first render).
    - The `e` key is reserved for the edit modal, not for environment switching. Environment switching uses `<ctrl>+e`.
    - Tab completion in the context popup: the `case "tab":` handler must check `m.showRootPopup && len(m.rootInput) > 0` and complete to the first matching root context.

## Developer checklist to reimplement
    - Create Go module, add dependencies: bubbletea, bubbles, lipgloss, yaml.
    - Generate OpenAPI client using .devenv/scripts/generate-api-client.sh from resources/operaton-rest-api.json.
    - Define configuration structs and YAML load/save functions.
    - Implement API client wrapper (api.go) that uses the generated OpenAPI client with robust handling of nullable types.
    - Implement Bubble Tea model with the fields and helpers described.
    - Implement Update() key handling and command orchestration.
    - Implement View() rendering the compact header (4 rows), boxed context selection (1 row), main boxed table (remaining height minus footer), and footer (1 row) with three columns and separators.
    - Add tests for config loading, client behavior, simple UI logic, pagination, edit modal, and navigation stack.

## Example flows
    - Start app -> default env selected -> fetch process definitions -> show table -> user navigates with arrows -> press Enter on definition -> fetch instances -> show instances -> press Enter on instance -> fetch variables -> show variables table (name, value, type) -> press Esc to go back to instances -> press Esc to go back to definitions.
    - User presses `:` -> types `proc` -> inline completion suggests `ess-definitions` remainder -> Tab completes to `process-definitions` -> Enter switches context (if exact) and reloads table.
    - User in variables view -> presses `e` -> edit modal opens on first editable column -> Tab to next column -> Enter saves -> modal closes.
    - User in instances view -> presses `<ctrl>+d` -> ModalConfirmDelete shown -> presses `<ctrl>+d` again -> instance terminated.



# Appendix

## Important API endpoints (Operaton engine-rest example)
- GET /process-definition
- GET /process-instance?processDefinitionKey=<key>
- GET /process-instance/{id}/variables
- DELETE /process-instance/{id}

## OpenAPI Client Generation

The application uses a generated Go client from the OpenAPI specification at resources/operaton-rest-api.json.

Generation Process:
- The script .devenv/scripts/generate-api-client.sh uses OpenAPI Generator (via Docker) to generate the client code.
- Generated files are placed in internal/operaton/.
- The generation uses the "go" generator with the following configuration:
  - Package name: operaton
  - isGoSubmodule: true (integrates with the main module)
  - withGoMod: false (uses the main go.mod)
- Generated files include API services for all endpoints, model DTOs, and configuration/authentication helpers.

Using the Generated Client:
- The api.go file wraps the generated client to provide a simpler interface for the application.
- Authentication is configured via context using operaton.ContextBasicAuth with BasicAuth credentials.
- The generated client uses NullableString, NullableInt32, and NullableBool types for optional fields.
- Helper functions (getStringValue, getInt32Value, getBoolValue) safely extract values from nullable types.

Regenerating the Client:
- Run .devenv/scripts/generate-api-client.sh whenever the OpenAPI specification is updated.
- The script requires Docker to be available.
- After generation, run `go mod tidy` to update dependencies (the script does this automatically).

## o8n logo

```
         ____
  ____  ( __ )____
 / __ \/ __  / __ \
/ /_/ / /_/ / / / /
\____/\____/_/ /_/

```


Contact
-------
If details are unclear or you want the spec extended (for example to include exact unit-test cases, more detailed layout mockups, or a list of exact table column mappings for all root contexts), tell me which parts to expand and I will update the specification.md accordingly.
